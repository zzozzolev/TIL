## 왜 쓸까?
- 데이터 파이프라인을 관리할 수 있다.
- 태스크들을 신뢰할 수 있는 방법으로 실행할 수 있다.

## 무엇일까?
- 태스크들을 올바른 시간에, 올바른 방법으로, 올바른 순서로 실행할 수 있게 해주는 오케스트레이터.

### 이점
- dynamic: 파이썬으로 데이터 파이프라인을 구축 가능하다.
- scaleability: 병렬적으로 원하는 만큼의 태스크를 수행할 수 있다.
- UI: UI를 통해 모니터링, 재실행등 편리하게 할 수 있다.
- extensibility: 필요한 게 있다면 airflow 업그레이드와 상관없이 플러그인을 만들어서 앱에 추가할 수 있다.

### 핵심 컴포넌트들
- web server: UI를 서빙하는 Gunicorn으로 이루어진 플라스크 서버.
- scheduler: 워크플로우들을 스케줄링하는 것을 책임지는 데몬. 에어플로우의 심장.
- metastore: 메타데이터가 저장되는 DB.
- executor: 어떻게 태스크들이 수행돼야할지 정의하는 클래스.
- worker: 태스크를 수행하는 프로세스와 서브 프로세스.

### DAG
- loop가 없고 방향성이 있는 그래프

### Operator
- 태스크에 대한 wrapper
- 종류
  - Action Operators: 함수나 커맨드를 수행하는 오퍼레이터
  - Transfer Operators: 소스와 데스티네이션 간에 데이터를 옮기는 오퍼레이터
  - Sensor Operators: 다음 태스크로 넘어가기 전에 뭔가가 일어나기 기다리는 오퍼레이터

### Task / Task Instance
- 오퍼레이터를 수행하면 오퍼레이터는 태스크 인스턴스가 된다.

### Workflow
- 오퍼레이터, 태스크, 디펜던시를 가지는 DAG.

### airflow가 아닌 것
- 데이터 스트리밍 솔루션이나 데이터 프로세싱 프레임워크가 아니다.
- 에어플로우 내에서 TB 단위의 데이터를 처리하지 마라.

## airflow 동작 방식
### One Node Architecture
- 노드 하나에 웹 서버, 스케줄러, 메타 스토어, 익스큐터(큐)가 있다.
- 웹 서버는 메타스토어에서 메타 데이터를 페치한다.
- 스케줄러는 메타스토어와 익스큐터에 태스크를 수행하기 위해 요청을 보낼 수 있다.
- 익스큐터는 메타스토어에 태스크들의 상태를 업데이트할 것이다.
- 큐는 익스큐터의 일부분이다.
- 작은 규모에서는 싱글 노드로 해도 괜찮다.

### Multi Nodes Architecture (Celery)
- 노드 하나에 웹 서버, 스케줄러, 익스큐더가 있고 다른 노드에 메타스토어와 큐가 있다.
- 주의할 점은 큐가 익스큐터 밖에 있다는 것이다.
- 태스크를 수행할 워커 노드들도 가진다.
- 워커 노드들은 태스크들을 나눠서 수행한다.
- 웹 서버는 메타스토어에서 메타 데이터를 가져온다.
- 스케줄러는 태스크를 스케줄하기 위해 메타스토어와 익스큐터에 말을 건다.
- 익스큐터는 큐에 태스크를 푸쉬한다.
- 태스크들이 큐에 있다면, 워커들은 태스크들을 가져와서 자신의 머신에서 수행한다.

### 동작 방식
- 싱글 노드 아키텍처 기준으로 설명한다.
- 데이터 파이프라인을 넣는 folder dags가 있다.
1. 새로운 DAG 파이썬 파일을 여기에 넣으면 웹 서버와 스케줄러가 새로운 데이터 파이프라인을 알기 위해 파싱을 한다.
2. 파싱이 끝나면 스케줄러는 `DagRun` 오브젝트(DAG의 인스턴스)를 만든다.
3. 메타스토어에서 `DagRun` 오브젝트는 running으로 표시된다.
4. 데이터 파이프라인에서 수행될 첫번째 태스크는 스케줄된다.
5. 태스크 인스턴스 오브젝트가 생성된다면 스케줄러에의해 익스큐터에 보내진다.
6. 익스큐터는 태스크를 수행하고 태스크의 상태를 메타스토어에 업데이트한다.
7. 스케줄러는 태스크가 끝났는지 체크한다.
8. 웹서버는 UI에 태스크의 상태를 업데이트한다.

## CLI
- `airflow db init`: 처음 메타스토어를 초기화할 때 필요하고 이후에는 하면 안 된다.
- `airflow db reset`: 메타스토어 내용을 모두 비우는 것이므로 프로덕션에서는 추천하지 않는다.
- `airflow scheduler`: 스케줄러를 실행한다.
- `airflow dags list`: dag들을 볼 수 있다.
- `airflow tasks list {dag name}`: dag와 관련된 태스크들을 볼 수 있다. 만약 태스크가 뜨지 않았다면 파싱 에러가 발생한 것이다.
- `airflow dags trigger`: 데이터 파이프라인을 실행할 수 있게 해준다.

## DAG가 뭘까?
- 데이터 파이프라인
- Directed Acyclic Graph
- 루프가 없고 노드가 태스크이고 엣지가 디펜던시인 그래프
